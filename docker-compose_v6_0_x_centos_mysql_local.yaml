version: '3.8'
services:
 zabbix-build-base:
  build:
   context: ./Dockerfiles/build-base/${CENTOS_OS_TAG_SHORT}
   cache_from:
    - "${CENTOS_CACHE_FROM}"
  image: ${BUILD_BASE_IMAGE}:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  profiles:
   - build1

 zabbix-build-mysql:
  build:
   context: ./Dockerfiles/build-mysql/${CENTOS_OS_TAG_SHORT}
   cache_from:
    - "${CENTOS_CACHE_FROM}"
   args:
    BUILD_BASE_IMAGE: ${BUILD_BASE_IMAGE}:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  image: ${BUILD_BASE_MYSQL_IMAGE}:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  profiles:
   - build2
  depends_on:
   - ${BUILD_BASE_IMAGE}

 zabbix-server:
  extends:
   file: compose_zabbix_components.yaml
   service: server-mysql
  build: 
   context: ./Dockerfiles/server-mysql/${CENTOS_OS_TAG_SHORT}
   cache_from:
    - "${CENTOS_CACHE_FROM}"
   args:
    BUILD_BASE_IMAGE: ${BUILD_BASE_MYSQL_IMAGE}:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  image: ${ZABBIX_SERVER_MYSQL_IMAGE}:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  container_name: zbx-server-mysql
  profiles:
   - make5
   - make6
   - start5
   - start6
  depends_on:
   - mysql-server
   - zabbix-build-mysql
  labels:
   com.zabbix.description: "Zabbix server with MySQL database support"
   com.zabbix.os: "${CENTOS_OS_TAG}"

 zabbix-proxy-mysql:
  extends:
   file: compose_zabbix_components.yaml
   service: proxy-mysql
  build:
   context: ./Dockerfiles/proxy-mysql/${CENTOS_OS_TAG_SHORT}
   cache_from:
    - "${CENTOS_CACHE_FROM}"
   args:
    BUILD_BASE_IMAGE: ${BUILD_BASE_MYSQL_IMAGE}:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  image: ${ZABBIX_PROXY_MYSQL_IMAGE}:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  container_name: zbx-proxy-mysql
  profiles:
   - make5
   - make6
   - prxstart5
   - prxstart6
  depends_on:
   - mysql-server
   - zabbix-java-gateway
   - zabbix-snmptraps
   - zabbix-build-mysql
  labels:
   com.zabbix.os: "${CENTOS_OS_TAG}"

 zabbix-web-nginx-mysql:
  extends:
   file: compose_zabbix_components.yaml
   service: web-nginx-mysql
  build:
   context: ./Dockerfiles/web-nginx-mysql/${CENTOS_OS_TAG_SHORT}
   cache_from:
    - "${CENTOS_CACHE_FROM}"
   args:
    BUILD_BASE_IMAGE: ${BUILD_BASE_MYSQL_IMAGE}:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  image: ${ZABBIX_WEB_NGINX_MYSQL_IMAGE}:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  container_name: zbx-web-nginx-mysql
  profiles:
   - zabbix-web-nginx-mysql
   - make5
   - make6
   - start5
   - start6
  depends_on:
   - mysql-server
   - zabbix-server
   - zabbix-build-mysql
  labels:
   com.zabbix.os: "${CENTOS_OS_TAG}"

 zabbix-agent2:
  extends:
   file: compose_zabbix_components.yaml
   service: agent2
  build:
   context: ./Dockerfiles/agent2/${CENTOS_OS_TAG_SHORT}
   cache_from:
    - "${CENTOS_CACHE_FROM}"
   args:
    BUILD_BASE_IMAGE: ${BUILD_BASE_MYSQL_IMAGE}:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  image: zabbix-agent2:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  container_name: zbx-agent2
  profiles:
   - make5
   - make6
   - start5
   - start6
  pid: "host"
  depends_on:
    - zabbix-build-mysql
  labels:
   com.zabbix.os: "${CENTOS_OS_TAG}"

 zabbix-java-gateway:
  extends:
   file: compose_zabbix_components.yaml
   service: java-gateway
  build:
   context: ./Dockerfiles/java-gateway/${CENTOS_OS_TAG_SHORT}
   cache_from:
    - "${CENTOS_CACHE_FROM}"
   args:
    BUILD_BASE_IMAGE: ${BUILD_BASE_MYSQL_IMAGE}:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  image: zabbix-java-gateway:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  container_name: zbx-java-gateway
  profiles:
   - make5
   - make6
   - start5
   - start6
   - prxstart5
   - prxstart6
  depends_on:
   - zabbix-build-mysql
  labels:
   com.zabbix.os: "${CENTOS_OS_TAG}"

 zabbix-snmptraps:
  extends:
   file: compose_zabbix_components.yaml
   service: snmptraps
  build:
   context: ./Dockerfiles/snmptraps/${CENTOS_OS_TAG_SHORT}
   cache_from:
    - "${CENTOS_CACHE_FROM}"
  image: zabbix-snmptraps:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  container_name: zbx-snmptraps
  profiles:
   - make5
   - make6
   - start5
   - start6
  labels:
   com.zabbix.os: "${CENTOS_OS_TAG}"

 zabbix-web-service:
  extends:
   file: compose_zabbix_components.yaml
   service: web-service
  build:
   context: ./Dockerfiles/web-service/${CENTOS_OS_TAG_SHORT}
   cache_from:
    - "${CENTOS_CACHE_FROM}"
   args:
    BUILD_BASE_IMAGE: ${BUILD_BASE_MYSQL_IMAGE}:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  image: ${ZABBIX_WEB_SERVICE_IMAGE}:${ZABBIX_CENTOS_IMAGE_TAG}${ZABBIX_IMAGE_TAG_POSTFIX}
  container_name: zbx-web-service
  profiles:
   - make6
   - start6
  depends_on:
   - zabbix-build-mysql
  labels:
   com.zabbix.os: "${CENTOS_OS_TAG}"

 mysql-server:
  extends:
   file: compose_databases.yaml
   service: mysql-server
  container_name: zbx-mariadb
  profiles:
   - make5
   - make6
   - start5
   - start6
   - prxstart5
   - prxstart6

  # if you are running as root then set it to 0
  # else find the right id with the id -u command
  # adding the mount volume point which we create earlier
 grafana:
  image: grafana/grafana-enterprise:${GRAFANA_IMAGE_TAG}
  container_name: zbx-grafana
  restart: unless-stopped
  user: '0'
  profiles:
   - make5
   - make6
   - start5
   - start6
  ports:
   - '3000:3000'
  environment:
   GF_SERVER_PROTOCOL: "https"
   GF_SERVER_CERT_FILE: "/etc/grafana/ssl/server.pem"
   GF_SERVER_CERT_KEY: "/etc/grafana/ssl/server.pem"
  volumes:
   - ${DATA_DIRECTORY}/data/ssl:/etc/grafana/ssl:rw
   - ${DATA_DIRECTORY}/data:/var/lib/grafana:rw
   - ${DATA_DIRECTORY}/data/plugins:/var/lib/grafana/plugins:rw
  networks:
   zbx_net_backend:
    aliases:
     - grafana-server
     - grafana
   zbx_net_frontend:

 loki:
  image: grafana/loki:${GRAFANA_LOKI_IMAGE_TAG}
  container_name: zbx-loki
  restart: unless-stopped
  user: '0'
  profiles:
   - make5
   - make6
   - start5
   - start6
  ports:
   - '3100:3100'
  command: -config.file=/mnt/config/loki-config.yaml
  # environment:
   # GF_SERVER_PROTOCOL: "https"
   # GF_SERVER_CERT_FILE: "/etc/grafana/ssl/server.pem"
   # GF_SERVER_CERT_KEY: "/etc/grafana/ssl/server.pem"
  volumes:
   - ${DATA_DIRECTORY}/loki/config:/mnt/config:rw
  networks:
   zbx_net_backend:
    aliases:
     - loki-server
     - loki
   zbx_net_frontend:
   
 promtail:
  image: grafana/promtail:${GRAFANA_PROMTAIL_IMAGE_TAG}
  container_name: zbx-promtail
  restart: unless-stopped
  user: '0'
  profiles:
   - make5
   - make6
   - start5
   - start6
  volumes:
    # chmod a+rw /var/run/docker.sock
   - /var/run/docker.sock:/var/run/docker.sock:rw
   - ${DATA_DIRECTORY}/promtail/config:/mnt/config:rw
   - /var/log/loki:/var/log/loki:rw
  command: -config.file=/mnt/config/promtail-config.yaml
  networks:
   zbx_net_backend:
    aliases:
     - promtail-server
     - promtail
   zbx_net_frontend:


# elasticsearch:
#  image: elasticsearch
#  profiles:
#   - full
#   - all
#  environment:
#   - transport.host=0.0.0.0
#   - discovery.zen.minimum_master_nodes=1
#  networks:
#   zbx_net_backend:
#    aliases:
#     - elasticsearch

networks:
  zbx_net_frontend:
    driver: bridge
    driver_opts:
      com.docker.network.enable_ipv6: "${FRONTEND_ENABLE_IPV6}"
    ipam:
      driver: "${FRONTEND_NETWORK_DRIVER}"
      config:
      - subnet: "${FRONTEND_SUBNET}"
  zbx_net_backend:
    driver: bridge
    driver_opts:
      com.docker.network.enable_ipv6: "${BACKEND_ENABLE_IPV6}"
    internal: true
    ipam:
      driver: ${FRONTEND_NETWORK_DRIVER}
      config:
      - subnet: "${BACKEND_SUBNET}"
  zbx_net_database:
    driver: bridge
    driver_opts:
      com.docker.network.enable_ipv6: "${DATABASE_NETWORK_ENABLE_IPV6}"
    internal: true
    ipam:
      driver: "${DATABASE_NETWORK_DRIVER}"

volumes:
  snmptraps:

secrets:
  MYSQL_USER:
    file: ${ENV_VARS_DIRECTORY}/.MYSQL_USER
  MYSQL_PASSWORD:
    file: ${ENV_VARS_DIRECTORY}/.MYSQL_PASSWORD
  MYSQL_ROOT_USER:
    file: ${ENV_VARS_DIRECTORY}/.MYSQL_ROOT_USER
  MYSQL_ROOT_PASSWORD:
    file: ${ENV_VARS_DIRECTORY}/.MYSQL_ROOT_PASSWORD
#  client-key.pem:
#    file: ${ENV_VARS_DIRECTORY}/.ZBX_DB_KEY_FILE
#  client-cert.pem:
#    file: ${ENV_VARS_DIRECTORY}/.ZBX_DB_CERT_FILE
#  root-ca.pem:
#    file: ${ENV_VARS_DIRECTORY}/.ZBX_DB_CA_FILE
#  server-cert.pem:
#    file: ${ENV_VARS_DIRECTORY}/.DB_CERT_FILE
#  server-key.pem:
#    file: ${ENV_VARS_DIRECTORY}/.DB_KEY_FILE
